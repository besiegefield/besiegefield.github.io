<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Agentic Building â€“ Code Typewriter</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
:root{
  --speed:60ms;          /* æ‰“å­—é€Ÿåº¦ */
  --cursor:#7ec699;
  --font:14px/1.6 "Fira Code","Consolas",monospace;
}
/* å®¹å™¨ï¼šæ”¯æŒå¤šè¡Œå¤šåˆ—å¸ƒå±€ */
#container{background:#1e1e1e;padding:40px;min-height:100vh}
.stage-row{display:flex;gap:20px;justify-content:center;align-items:flex-start;margin-bottom:20px}
/* å•ä¸ªèˆå° */
.stage{background:#282c34;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,.6);display:flex;overflow:hidden;position:relative;margin-bottom:60px}
/* å·¦ä¾§ä»£ç åŒº */
.left{height:100%;display:flex;flex-direction:column;padding:20px;box-sizing:border-box;position:relative;overflow:hidden}
pre{margin:0;font:var(--font);color:#abb2bf;flex:1;overflow-y:auto;overflow-x:hidden;white-space:pre;box-sizing:border-box}
code{white-space:pre!important;display:block}
/* JSON è¯­æ³•é«˜äº®é¢œè‰² */
.json-string{color:#98c379;font-weight:500}
.json-number{color:#d19a66;font-weight:500}
.json-bracket{color:#61afef;font-weight:bold}
.json-colon{color:#56b6c2}
.json-comma{color:#abb2bf}
.json-quote{color:#c678dd}
.key-type{color:#e06c75;font-weight:600}
.key-id{color:#61afef;font-weight:600}
.key-parent{color:#c678dd;font-weight:600}
.key-face_id{color:#e5c07b;font-weight:600}
.key-order_id{color:#56b6c2;font-weight:600}
.key-bp_id{color:#98c379;font-weight:600}
.key-default{color:#d19a66;font-weight:600}
/* XML è¯­æ³•é«˜äº® - ä¿æŒå­—ç¬¦ç­‰å®½ï¼Œä¸ä½¿ç”¨ font-weight */
.xml-tag-bracket{color:#808080}
.xml-tag-name{color:#e06c75}
.xml-attr-name{color:#d19a66}
.xml-attr-value{color:#98c379}
.xml-number{color:#d19a66}
.cursor{display:inline-block;width:10px;height:1.1em;background:var(--cursor);vertical-align:text-bottom;animation:blink 1s steps(2,start) infinite}
@keyframes blink{to{background:transparent}}
/* å³ä¾§å›¾ç‰‡åŒº */
.right{height:100%;background:#000;display:flex;align-items:center;justify-content:center;min-width:300px}
.right img{max-width:90%;max-height:90%;object-fit:contain;border-radius:4px}
/* æ§åˆ¶æ  */
.ctrl{position:absolute;bottom:-48px;left:0;right:0;display:flex;justify-content:center;gap:12px}
.ctrl button{background:#3e4451;color:#fff;border:none;padding:6px 18px;border-radius:4px;cursor:pointer;font-size:14px}
.ctrl button:hover{background:#5c6370}
body{background:#1e1e1e;margin:0;padding:0}
/* éšè—çš„æµ‹é‡å…ƒç´  */
#measure{position:absolute;visibility:hidden;white-space:pre;font:var(--font);pointer-events:none;top:-9999px}
</style>
</head>
<body>

<div id="container"></div>
<div id="measure"></div>

<script>
/****************  é…ç½®åŒºï¼ˆåªæ”¹è¿™é‡Œï¼‰  ****************/
// æ”¯æŒå¤šä¸ªä»£ç -å›¾ç‰‡å¯¹ï¼Œä½¿ç”¨ row æŒ‡å®šåœ¨ç¬¬å‡ è¡Œæ˜¾ç¤º
const stages = [
  {
    row: 1,  // ç¬¬ä¸€è¡Œ
    code: `Let's build a catapult!
<starting_block        parent=-1                    attach_to=-1>
<small_woolden_block_1 parent=starting_block        attach_to=face_1>
<small_woolden_block_2 parent=starting_block        attach_to=face_2>
<small_woolden_block_3 parent=small_woolden_block_1 attach_to=face_1>
<small_woolden_block_4 parent=small_woolden_block_2 attach_to=face_3>
<woolden_block_1       parent=starting_block        attach_to=face_3>
<woolden_block_2       parent=woolden_block_1       attach_to=face_3>
<small_woolden_block_5 parent=starting_block        attach_to=face_0>
<woolden_block_3       parent=small_woolden_block_5 attach_to=face_5>
<spinning_block_1      parent=woolden_block_3       attach_to=face_2>
<log_1                 parent=spinning_block_1      attach_to=face_3>
<holder_1              parent=log_1                 attach_to=face_0>
<boulder_1             parent=holder_1              attach_to=face_0>
`,
    lineMap: {
      3: 'figures/agentic_building/build/1.png',
      4: 'figures/agentic_building/build/2.png',
      5: 'figures/agentic_building/build/3.png',
      6: 'figures/agentic_building/build/4.png',
      7: 'figures/agentic_building/build/5.png',
      8: 'figures/agentic_building/build/6.png',
      9: 'figures/agentic_building/build/7.png',
      10: 'figures/agentic_building/build/8.png',
      11: 'figures/agentic_building/build/9.png',
      12: 'figures/agentic_building/build/10.png',
      13: 'figures/agentic_building/build/11.png',
      14: 'figures/agentic_building/build/12.png'
    },
    defaultPic: 'figures/agentic_building/build/0.png',
    imageWidth: 450,  // å›¾ç‰‡åŒºå®½åº¦
    stageHeight: 400  // èˆå°é«˜åº¦
  }
];

const charInterval = 10;
const cacheVersion = '20251019';
/*********************************************************/

const container = document.getElementById('container');
const measureEl = document.getElementById('measure');

// è®¡ç®—æ–‡æœ¬æœ€å¤§å®½åº¦ï¼ˆåƒç´ ï¼‰
function measureCodeWidth(code){
  measureEl.textContent = '';
  const lines = code.split('\n');
  let maxWidth = 0;
  
  lines.forEach(line => {
    measureEl.textContent = line;
    const width = measureEl.offsetWidth;
    if(width > maxWidth) maxWidth = width;
  });
  
  return maxWidth + 40; // åŠ ä¸Š padding
}

// XML è¯­æ³•é«˜äº®
function highlightChar(ch, prevChars){
  const fullText = prevChars.join('');
  const currentLine = fullText.split('\n').pop();
  
  const lastOpenBracket = currentLine.lastIndexOf('<');
  const lastCloseBracket = currentLine.lastIndexOf('>');
  const inTag = lastOpenBracket > lastCloseBracket && lastOpenBracket !== -1;
  
  if(ch === '<'){
    return `<span class="xml-tag-bracket">&lt;</span>`;
  }
  if(ch === '>'){
    return `<span class="xml-tag-bracket">&gt;</span>`;
  }
  
  if(!inTag){
    return ch;
  }
  
  const inTagContent = currentLine.substring(lastOpenBracket + 1);
  
  if(ch === '=' || ch === ' '){
    return ch;
  }
  
  const lastSpaceInTag = inTagContent.lastIndexOf(' ');
  const lastEqualInTag = inTagContent.lastIndexOf('=');
  
  if(lastSpaceInTag === -1){
    if(/[a-zA-Z0-9_]/.test(ch)){
      return `<span class="xml-tag-name">${ch}</span>`;
    }
  }
  else if(lastEqualInTag > lastSpaceInTag){
    const afterEqual = inTagContent.substring(lastEqualInTag + 1);
    if(!/\s/.test(afterEqual)){
      if(/[\d\-]/.test(ch)){
        return `<span class="xml-number">${ch}</span>`;
      }
      if(/[a-zA-Z0-9_]/.test(ch)){
        return `<span class="xml-attr-value">${ch}</span>`;
      }
    }
  }
  else if(lastSpaceInTag > lastEqualInTag){
    const afterSpace = inTagContent.substring(lastSpaceInTag + 1);
    if(!/=/.test(afterSpace)){
      if(/[a-zA-Z_]/.test(ch)){
        return `<span class="xml-attr-name">${ch}</span>`;
      }
    }
  }
  
  return ch;
}

// åˆ›å»ºå•ä¸ªèˆå°
function createStage(config, stageIndex){
  const { code, lineMap, defaultPic, imageWidth, stageHeight } = config;
  
  // è®¡ç®—ä»£ç åŒºå®½åº¦
  const codeWidth = measureCodeWidth(code);
  const totalWidth = codeWidth + imageWidth;
  
  // åˆ›å»ºèˆå°å…ƒç´ 
  const stage = document.createElement('div');
  stage.className = 'stage';
  stage.style.width = totalWidth + 'px';
  stage.style.height = stageHeight + 'px';
  
  const left = document.createElement('div');
  left.className = 'left';
  left.style.width = codeWidth + 'px';
  
  const pre = document.createElement('pre');
  const codeBlock = document.createElement('code');
  pre.appendChild(codeBlock);
  left.appendChild(pre);
  
  const right = document.createElement('div');
  right.className = 'right';
  right.style.width = imageWidth + 'px';
  
  const img = document.createElement('img');
  img.src = defaultPic + '?v=' + cacheVersion;
  right.appendChild(img);
  
  const ctrl = document.createElement('div');
  ctrl.className = 'ctrl';
  ctrl.innerHTML = `
    <button class="play-btn">â–¶ Play</button>
    <button class="pause-btn">â¸ Pause</button>
    <button class="replay-btn">ğŸ”„ Replay</button>
  `;
  
  stage.appendChild(left);
  stage.appendChild(right);
  stage.appendChild(ctrl);
  
  // é¢„åŠ è½½å›¾ç‰‡
  const allImages = [defaultPic, ...Object.values(lineMap)];
  allImages.forEach(src => {
    const preloadImg = new Image();
    preloadImg.src = src + '?v=' + cacheVersion;
  });
  
  // æ‰“å­—æœºçŠ¶æ€
  let index = 0;
  let timer = null;
  let paused = false;
  let currentLine = 1;
  
  function setImage(url){
    img.src = (url || defaultPic) + '?v=' + cacheVersion;
  }
  
  function typeChar(){
    if(paused) return;
    if(index >= code.length){
      clearInterval(timer);
      codeBlock.insertAdjacentHTML('beforeend','<span class="cursor"></span>');
      setTimeout(() => {
        replay();
      }, 3000);
      return;
    }
    const ch = code[index++];
    const prevChars = code.slice(0, index-1).split('');
    
    let displayCh = ch;
    if(ch === '&') displayCh = '&amp;';
    else if(ch === '\n') displayCh = '\n';
    else displayCh = highlightChar(ch, prevChars);
    
    if(ch === '\n'){
      codeBlock.insertAdjacentHTML('beforeend', '\n');
      currentLine++;
      if(lineMap[currentLine]) setImage(lineMap[currentLine]);
    }else{
      codeBlock.insertAdjacentHTML('beforeend', displayCh);
    }
    
    const oldCur = codeBlock.querySelector('.cursor');
    if(oldCur) oldCur.remove();
    codeBlock.insertAdjacentHTML('beforeend','<span class="cursor"></span>');
    pre.scrollTop = pre.scrollHeight;
  }
  
  function start(){
    paused=false;
    if(timer)clearInterval(timer);
    timer=setInterval(typeChar,charInterval);
  }
  
  function pause(){
    paused=true;
  }
  
  function replay(){
    codeBlock.innerHTML='';
    index=0;
    currentLine=1;
    setImage(defaultPic);
    start();
  }
  
  ctrl.querySelector('.play-btn').onclick = start;
  ctrl.querySelector('.pause-btn').onclick = pause;
  ctrl.querySelector('.replay-btn').onclick = replay;
  
  start();
  
  return stage;
}

// æŒ‰è¡Œåˆ†ç»„èˆå°
const rowGroups = {};
stages.forEach(config => {
  const row = config.row || 1;
  if(!rowGroups[row]) rowGroups[row] = [];
  rowGroups[row].push(config);
});

// æŒ‰è¡Œå·æ’åºï¼Œåˆ›å»ºè¡Œå®¹å™¨å¹¶æ·»åŠ èˆå°
const sortedRows = Object.keys(rowGroups).sort((a, b) => a - b);
sortedRows.forEach(rowNum => {
  const rowDiv = document.createElement('div');
  rowDiv.className = 'stage-row';
  
  // è®¡ç®—è¯¥è¡Œæœ€å¤§é«˜åº¦
  const rowConfigs = rowGroups[rowNum];
  const maxRowHeight = Math.max(...rowConfigs.map(c => c.stageHeight));
  
  // ä¸ºè¯¥è¡Œçš„æ¯ä¸ªèˆå°è®¾ç½®ç»Ÿä¸€é«˜åº¦
  rowConfigs.forEach((config, index) => {
    const uniformConfig = { ...config, stageHeight: maxRowHeight };
    const stage = createStage(uniformConfig, index);
    rowDiv.appendChild(stage);
  });
  
  container.appendChild(rowDiv);
});
</script>
</body>
</html>
